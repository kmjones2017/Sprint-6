📄 One‑Page Handout: Batch Inserts, Transactions & Rollbacks in MySQL
Why This Matters
When inserting data into a relational database — especially one with foreign keys like our pharma_db — you want to avoid:
* Partial inserts
* Broken relationships
* Corrupted data
* Failed ETL runs
Batch inserts, transactions, and rollbacks are the tools that keep your data clean and your workflows reliable.
________________


1. Batch Insert Logic
Batch inserts let you insert multiple rows in one statement. This is faster and reduces database overhead.
Example:
INSERT INTO customers (customer_id, name, customer_type, email, phone, address)
VALUES
    (7, 'HealthFirst Clinic', 'Clinic', 'contact@healthfirst.com', '555-111-2222', '12 Wellness Way'),
    (8, 'Metro Pharmacy', 'Pharmacy', 'info@metropharm.com', '555-333-4444', '88 City Center Blvd'),
    (9, 'CarePoint Medical', 'Hospital', 'admin@carepoint.com', '555-555-6666', '101 CarePoint Dr');


When to use:
* Loading CSVs
* ETL pipelines
* API ingestion
* Any time you need speed and efficiency
________________


2. Transactions
A transaction groups multiple SQL statements into a single atomic operation.
Atomic = all succeed or none succeed.
Example:
START TRANSACTION;


INSERT INTO customers (customer_id, name, customer_type, email, phone, address)
VALUES (10, 'Harbor Clinic', 'Clinic', 'hello@harborclinic.com', '555-777-8888', '77 Harbor Rd');


INSERT INTO orders (order_id, customer_id, order_date)
VALUES (9, 10, '2024-06-01');


COMMIT;


Why it matters:
* Prevents partial inserts
* Ensures referential integrity
* Makes ETL steps safe to retry
________________


3. Rollback on Failure (with Handler)
A rollback undoes everything in the transaction if an error occurs.
A handler is MySQL’s version of a try/except block — it catches errors and triggers the rollback.
Example:
DROP PROCEDURE IF EXISTS insert_order_with_items;


DELIMITER $$


CREATE PROCEDURE insert_order_with_items()
BEGIN
    DECLARE exit handler FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
    END;


    START TRANSACTION;


    INSERT INTO orders (order_id, customer_id, order_date)
    VALUES (21, 1, '2024-06-02');


    INSERT INTO order_items (order_item_id, order_id, batch_id, quantity, unit_price)
    VALUES (31, 21, 999, 200, 12.50);  -- invalid batch_id triggers rollback


    COMMIT;
END$$


DELIMITER ;


What the handler does:
* Detects any SQL error
* Automatically rolls back
* Prevents corrupted or incomplete data
________________


4. How This Fits Into Prefect
Prefect expects tasks to be:
* Atomic (safe to retry)
* Idempotent (no double inserts)
* Consistent (no partial state)
Transactions + rollbacks give you exactly that.
Workflow pattern:
* Extract → Transform → Insert (transaction)
* If insert fails → Rollback
* Prefect retries safely
________________


5. Summary
Concept
	Purpose
	Benefit
	Batch Insert
	Insert multiple rows at once
	Faster, fewer DB calls
	Transaction
	Group statements into one atomic unit
	All-or-nothing safety
	Rollback
	Undo changes on error
	Prevents bad data
	Handler
	Catch SQL errors
	Automates rollback
	Prefect Integration
	Orchestrate ETL safely
	Clean retries, reliable pipelines